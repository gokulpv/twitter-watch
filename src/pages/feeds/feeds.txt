import React from "react";
// components
import Tweet from "../../components/tweet/tweet";
import Loader from "../../components/loader/loader";
import { useIntersection } from "../../hooks/useIntersectionObserver";
import { PageHeader } from "./feed.components";
import { useRouteMatch } from "react-router-dom";

// actions
import { getTweets } from "./Feed.actions";

let lastId = {};

const Feed = () => {
  // get params from url.
  const { path } = useRouteMatch();
  const handleName = path.replace("/", "");
  const bottomElement = React.useRef();
  const [tweets, setTweets] = React.useState({});

  // Custom hook for observing intersection ( Direction : bottom  up  )
  const { count } = useIntersection(bottomElement, {
    rootMargin: "0px 0px -20px 0px",
  });

  // Make new requests upon the first render and and subsequently after intersection entry
  React.useEffect(() => {
    getTweets(handleName, lastId[handleName]).then((data) => {
      if (data) {


        const isTweetsEmpty = !tweets[handleName];
        if (isTweetsEmpty) {
          setTweets({
            [handleName]: data,
            ...tweets,
          });
        } else {
          // Remove first element from every batch starting from second api call
          tweets[handleName].shift();
          setTweets({
            ...tweets,
            [handleName]: [...tweets[handleName], ...data],
          });
        }
        lastId[handleName] = data[data.length - 1]?.id_str;
      }
    });

    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [count]);

  return (
    <>
      {tweets && Object.keys(tweets).length > 0 && (
        <>
          <PageHeader data-testid="top-element">
            <div>Latest tweets </div>
            <div>
              Showing results for <span>{`@${handleName}`}</span>
            </div>
          </PageHeader>{" "}
          {tweets[handleName]?.map((tweet, idx) => (
            <Tweet key={idx} tweet={tweet} data-testid="tweet" />
          ))}
        </>
      )}
      <div ref={bottomElement}>
        <Loader data-testid="loader" />
      </div>
    </>
  );
};

export default Feed;



index.js:1 Warning: Can't perform a React state update on an unmounted component. This is a no-op, but it indicates a memory leak in your application. To fix, cancel all subscriptions and asynchronous tasks in a useEffect cleanup function.
    in Feed (at App.js:24)
    in main (created by styled.main)
    in styled.main (at layout.jsx:17)
    in div (created by styled.div)
    in styled.div (at layout.jsx:15)
    in MainLayout (at App.js:23)
    in Route (at App.js:22)